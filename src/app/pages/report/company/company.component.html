<app-breadcrumb [step]="step" [draftReport]="draftReport"></app-breadcrumb>
<section class="section section-white position-relative" *ngIf="draftReport">
  <div class="container max-width">

    <ng-container *ngIf="draftReport.draftCompany; else noCompany">
      <div class="panel">

        <div class="row mb-2">
          <div class="col-8">
            <strong>Entreprise {{draftReport.draftCompany.siret || draftReport.draftCompany.name ? 'identifiée' : 'non identifiée'}}</strong>
          </div>
          <div class="col-4 text-right">
            <span class="link pointer" (click)="changeCompany()" (keydown.enter)="changeCompany()" aria-label="Modifier entreprise" tabindex="0">Modifier</span>
            <i class="material-icons md-18 edit" aria-hidden="true">edit</i>
          </div>
        </div>
        <p *ngIf="!draftReport.draftCompany.siret && !draftReport.draftCompany.name">
          Si vous ne parvenez pas à trouver le SIRET de l'entreprise, vous pouvez continuer votre signalement.
          <br />Il ne sera pas transmis à l'entreprise qui gère le site internet mais les enquêteurs de la répression des fraudes en seront informés.
        </p>
        <div class="row" *ngIf="draftReport.draftCompany.name">
          <div class="col-12">
            Nom : <strong>{{draftReport.draftCompany.name}}<br /></strong>
            Adresse : {{draftReport.draftCompany.address}}
          </div>
        </div>
        <div class="row" *ngIf="draftReport.draftCompany.siret">
          <div class="col-12">
            SIRET : {{draftReport.draftCompany.siret}}
          </div>
        </div>
        <div class="row mt-4" *ngIf="draftReport.draftCompany.website">
          <div class="col-12">
            Site internet : {{draftReport.draftCompany.website.url}}
          </div>
        </div>
      </div>
      <hr />
      <button type="submit" class="btn btn-lg btn-primary" (click)="selectCompany(draftReport.draftCompany)">
        <i class="material-icons md-24 d-none d-sm-inline-block" aria-hidden="true">play_arrow</i>
        Étape suivante : s'identifier
      </button>
    </ng-container>

    <ng-template #noCompany>

      <ng-container *ngIf="websiteForm">
        <h2 class="text-center mb-4 font-weight-bold">
          Informations sur l'entreprise
        </h2>

        <form [formGroup]="websiteForm" (submit)="submitWebsiteForm()" id="websiteForm">
          <div class="form__group mt-4">
            <label for="urlInput" [class]="hasError(urlCtrl) ? 'error' : ''">Adresse du site internet (URL) <span class="error">*</span>
            </label>
            <input type="text" class="form-control" [formControl]="urlCtrl" name="url" id="urlInput" placeholder="ex : https://www.site.fr"/>
          </div>

          <div class="notification error mt-3" *ngIf="showErrors && websiteForm.invalid">
            <span *ngIf="urlCtrl.hasError('required')">
              Veuillez renseigner l'url du site.<br />
            </span>
          </div>
          <button type="submit" class="btn btn-lg btn-primary mt-4 mb-4" *ngIf="!websiteForm.disabled; else websiteFormDisabled">
            Continuer
          </button>
        </form>

        <ng-template #websiteFormDisabled>
          <div class="text-right" *ngIf="websiteForm.disabled">
            <span class="link pointer" (click)="changeWebsite()" aria-label="Modifier adresse du site internet" tabindex="0">Modifier</span>
            <i class="material-icons md-18 edit" aria-hidden="true">edit</i>
          </div>
          <hr />
        </ng-template>
      </ng-container>

      <ng-container *ngIf="searchBySiretForm && searchForm">

        <h2 class="text-center mb-4 font-weight-bold">
          Pouvez-vous identifier l'entreprise ?
        </h2>

        <form>
          <div [ngClass]="getIdentificationClass(identificationKinds.Name)">
            <div class="row pb-2 pt-2">
              <div class="col-2 col-sm-1 text-right pr-1">
                <input type="radio" [(ngModel)]="identificationKind" name="identificationKind" [value]="identificationKinds.Name" id="identByName"/>
              </div>
              <div class="col-10 col-sm-11 pl-1">
                <label for="identByName" class="label-inline pointer">Par son nom et son code postal</label>
              </div>
            </div>
          </div>

          <div [ngClass]="getIdentificationClass(identificationKinds.Siret)">
            <div class="row pb-2 pt-2">
              <div class="col-2 col-sm-1 text-right pr-1">
                <input type="radio" [(ngModel)]="identificationKind" name="identificationKind" [value]="identificationKinds.Siret" id="identBySiret"/>
              </div>
              <div class="col-10 col-sm-11 pl-1">
                <label for="identBySiret" class="label-inline pointer">Par son SIRET</label>
              </div>
            </div>
          </div>

          <div [ngClass]="getIdentificationClass(identificationKinds.None)" *ngIf="draftReport.companyKind === companyKinds.WEBSITE">
            <div class="row pb-2 pt-2">
              <div class="col-2 col-sm-1 text-right pr-1">
                <input type="radio" [(ngModel)]="identificationKind" name="identificationKind" [value]="identificationKinds.None" id="noIdent"/>
              </div>
              <div class="col-10 col-sm-11 pl-1">
                <label for="noIdent" class="label-inline pointer">Je ne peux pas identifier l'entreprise</label>
              </div>
            </div>
          </div>
        </form>

        <div *ngIf="identificationKind === identificationKinds.Name">

          <hr />

          <form [formGroup]="searchForm" (submit)="searchCompany()" id="searchForm">

            <div class="form__group mt-4">
              <label for="searchInput" [class]="hasError(searchCtrl) ? 'error' : ''">Nom ou enseigne de l'entreprise signalée <span class="error">*</span>
              </label>
              <input type="text" class="form-control" formControlName="search" name="search" id="searchInput" placeholder="ex : boulangerie Petit Jean"/>
            </div>
            <div class="form__group">
              <label for="searchPostalCodeInput"[class]="hasError(searchPostalCodeCtrl) ? 'error' : ''">
                Code postal <span class="error">*</span>
              </label>
              <div class="row">
                <div class="col-12 col-sm-6">
                  <input type="text" class="form-control" formControlName="searchPostalCode" name="searchPostalCode" id="searchPostalCodeInput" placeholder="ex : 41110" />
                </div>
              </div>
            </div>
            <div>
              <small class="form-text text-muted">
                Vous pouvez signaler des entreprises privées établies en France uniquement.
              </small>
            </div>
            <div class="notification error mt-4" *ngIf="showErrors && searchForm.invalid">
              <span *ngIf="searchCtrl.hasError('required')">
                Veuillez renseigner le nom de l'entreprise.<br />
              </span>
              <span *ngIf="searchPostalCodeCtrl.hasError('required')">
                Veuillez renseigner le code postal.
              </span>
              <span *ngIf="searchPostalCodeCtrl.hasError('pattern')">
                Le code postal doit être composé de 5 chiffres.
              </span>
            </div>
            <button type="submit" class="btn btn-lg btn-primary mt-4 mb-4" id="submitSearchForm">
              <i class="material-icons md-24" aria-hidden="true">search</i>
              Rechercher
            </button>
          </form>

          <div *ngIf="companySearchResults && companySearchResults.length">

            <p class="mt-4">
              Veuillez sélectionner une entreprise dans la liste ci-dessous :
            </p>

            <div *ngFor="let companySearchResult of companySearchResults" class="company mb-3" (click)="selectCompanyFromResults(companySearchResult)" (keydown.enter)="selectCompanyFromResults(companySearchResult)" tabindex="0">
              <strong *ngIf="companySearchResult.name">{{companySearchResult.name}}<br /></strong>
              <strong *ngIf="companySearchResult.highlight">
                <i class="material-icons md-green">check_circle</i>
                <small class="text-success font-weight-bold">{{companySearchResult.highlight}}</small>
                <br />
              </strong>
              <span *ngIf="companySearchResult.activityLabel">{{companySearchResult.activityLabel}}<br /></span>
              <ng-container *ngIf="companySearchResult.address">
                <span *ngFor="let line of companySearchResult.address.split(' - ')">{{line}}<br/></span>
              </ng-container>
            </div>

            <div class="notification info mt-1">
              Si l'entreprise ne figure pas dans la liste, vous pouvez modifier votre recherche ou <span class="link" (click)="identificationKind = identificationKinds.Siret" tabindex="0">rechercher avec le numéro SIRET de l'entreprise</span>.
            </div>
          </div>

          <div class="notification warning mt-4" *ngIf="searchWarning">
            <p>
              {{searchWarning}}
            </p>
            Veuillez modifier votre recherche ou <span class="link" (click)="identificationKind = identificationKinds.Siret">rechercher avec le numéro SIRET de l'entreprise</span>.
          </div>

          <div class="notification error mt-4" *ngIf="searchError">
            <p>
              {{searchError}}
            </p>
            Veuillez réessayer ou <span class="link" (click)="identificationKind = identificationKinds.Siret">rechercher avec le numéro SIRET de l'entreprise</span>.
          </div>


        </div>

        <div *ngIf="identificationKind === identificationKinds.Siret">

          <hr />

          <form [formGroup]="searchBySiretForm" (submit)="searchCompanyBySiret()" id="searchBySiretForm">

            <div class="notification info">
              Le SIRET est un numéro composé de 14 chiffres identifiant l'entreprise concernée.
              SignalConso en a besoin pour la contacter et informer la répression des fraudes.
              <br/>
              <a data-toggle="collapse" href="#collapseHow">Comment retrouver un SIRET ?</a>
              <ul class="collapse" id="collapseHow">
                <li>
                  <a data-toggle="collapse" href="#collapseDoc">L'entreprise vous a remis un document ?</a>
                  <div class="collapse" id="collapseDoc">
                    Vous pourrez probablement retrouver le SIRET sur :
                    <ul>
                      <li>
                        <a data-toggle="collapse" href="#collapseTicket">le ticket de carte bleue</a>
                        <div class="collapse" id="collapseTicket">
                          <div class="card card-body">
                            Il y a plusieurs données chiffrées sur ce ticket mais vous pouvez facilement trouver le numéro à 14 chiffres qui se situe en principe entre l’adresse de l'entreprise et le montant de votre achat.
                          </div>
                        </div>
                      </li>
                      <li>
                        <a data-toggle="collapse" href="#collapseEstimate">un devis</a>
                        <div class="collapse" id="collapseEstimate">
                          <div class="card card-body">
                            Vous trouverez le plus souvent le numéro à 14 chiffres en dessous de l’adresse de l'entreprise (généralement en haut à gauche).
                          </div>
                        </div>
                      </li>
                      <li>
                        <a data-toggle="collapse" href="#collapseContract">un contrat</a>
                        <div class="collapse" id="collapseContract">
                          <div class="card card-body">
                            Vous trouverez le plus souvent le numéro à 14 chiffres en dessous de l’adresse de l'entreprise (généralement en haut à gauche).
                          </div>
                        </div>
                      </li>
                      <li>
                        Tout autre document ou échange avec l'entreprise (document publicitaire, signature à la fin d’un mail, grille des tarifs…).
                      </li>
                    </ul>
                  </div>
                </li>
                <li>
                  <a data-toggle="collapse" href="#collapseNoDoc">Vous n’avez pas de documents émanants de l'entreprise ?</a>
                  <div class="collapse" id="collapseNoDoc">
                    Faites une recherche en ligne sur :
                    <ul>
                      <li><a href="https://www.societe.com" target="_blank" title="societe.com (nouvelle fenêtre)">https://www.societe.com</a></li>
                      <li><a href="https://www.pagesjaunes.fr" target="_blank" title="pages jaunes (nouvelle fenêtre)">https://www.pagesjaunes.fr</a></li>
                      <li><a href="https://www.infogreffe.fr" target="https://www.infogreffe.fr" title="infogreffe (nouvelle fenêtre)">https://www.infogreffe.fr</a></li>
                    </ul>
                  </div>
                </li>
                <li>
                  <a data-toggle="collapse" href="#collapseNotFound">Vous n’avez pas trouvé le numéro SIRET ?</a>
                  <div class="collapse" id="collapseNotFound">
                    Utiliser <a href="https://www.economie.gouv.fr/contact/contacter-la-dgccrf?dest=professionnel" target="_blank">le formulaire en ligne DGCCRF</a>
                    <br />Ce formulaire ne nécessite pas le SIRET de l'entreprise.
                  </div>
                </li>
              </ul>
            </div>

            <div class="form__group mt-4">
              <label for="siret" [class]="hasErrorBySiret(siretCtrl) ? 'error' : ''">
                Numéro SIRET de l'entreprise <span class="error">*</span>
              </label>
              <input formControlName="siret" type="text" id="siret" placeholder="Ex: 83350861700010">
            </div>

            <div class="notification error mt-3" *ngIf="showErrorsBySiret && searchBySiretForm.invalid">
              <span *ngIf="siretCtrl.hasError('required')">
                Veuillez renseigner le numéro SIRET de l'entreprise.<br />
              </span>
              <span *ngIf="siretCtrl.hasError('pattern')">
                Le numéro SIRET doit être composé de 14 chiffres.
              </span>
            </div>
            <button type="submit" class="btn btn-lg btn-primary mt-4 mb-4" id="submitSiretForm">
              <i class="material-icons md-24" aria-hidden="true">search</i>
              Rechercher
            </button>

          </form>

          <div *ngIf="companySearchBySiretResult">

            <p class="mt-4">
              Veuillez cliquer sur l'entreprise ci-dessous si elle correspond bien à l'entreprise recherchée :
            </p>

            <div class="company mb-3" (click)="selectCompanyFromResults(companySearchBySiretResult)" (keydown.enter)="selectCompanyFromResults(companySearchBySiretResult)" tabindex="0">
              <strong *ngIf="companySearchBySiretResult.name">{{companySearchBySiretResult.name}}<br /></strong>
              <span *ngIf="companySearchBySiretResult.activityLabel">{{companySearchBySiretResult.activityLabel}}<br /></span>
              <ng-container *ngIf="companySearchBySiretResult.address">
                <span *ngFor="let line of companySearchBySiretResult.address.split(' - ')">{{line}}<br/></span>
              </ng-container>
            </div>

            <div class="notification info mt-1">
              Si l'entreprise n'est pas celle recherchée, vous pouvez modifier votre recherche.
            </div>

          </div>

          <div class="notification warning mt-4" *ngIf="searchBySiretWarning">
            <p>
              {{searchBySiretWarning}}
            </p>
            Veuillez modifier votre recherche.
          </div>

          <div class="notification error mt-4" *ngIf="searchBySiretError">
            <p>
              {{searchBySiretError}}
            </p>
            Veuillez réessayer.
          </div>

        </div>

        <div *ngIf="identificationKind === identificationKinds.None">

          <hr />

          <div class="notification info">
            Si vous ne parvenez pas à identifier l'entreprise, vous pouvez continuer votre signalement.
            <br />Il ne sera pas transmis à l'entreprise qui gère le site internet, sauf si cette dernière est française et identifiable par l'équipe de SignalConso.
            <br />Dans tous les cas les enquêteurs de la répression des fraudes en seront informés.
          </div>

          <button type="button" class="btn btn-lg btn-primary" (click)="selectCompany({})">
            <i class="material-icons md-24 d-none d-sm-inline-block" aria-hidden="true">play_arrow</i>
            Étape suivante : s'identifier
          </button>

        </div>

      </ng-container>
    </ng-template>

  </div>

  <ngx-loading [show]="loading"></ngx-loading>

</section>
