<app-breadcrumb [step]="step" [draftReport]="draftReport"></app-breadcrumb>
<section class="section section-white position-relative">
  <div class="container max-width">
    <ng-container *ngIf="draftReport">
      <ng-container *ngIf="draftReport.companyKind === companyKinds.SIRET; else website">
        <form (submit)="selectCompany(draftReport.companyData)" *ngIf="draftReport.companyData; else noCompany">
          <div class="row">
            <div class="col-12 text-center">
              <div class="company-card">
                  <strong *ngIf="draftReport.companyData.line1">{{draftReport.companyData.line1}}<br /></strong>
                  <strong *ngIf="draftReport.companyData.line2">{{draftReport.companyData.line2}}<br /></strong>
                  <span *ngIf="draftReport.companyData.line3">{{draftReport.companyData.line3}}<br /></span>
                  <span *ngIf="draftReport.companyData.line4">{{draftReport.companyData.line4}}<br /></span>
                  <span *ngIf="draftReport.companyData.line5">{{draftReport.companyData.line5}}<br /></span>
                  <span *ngIf="draftReport.companyData.line6">{{draftReport.companyData.line6}}<br /></span>
                  <span *ngIf="draftReport.companyData.line7">{{draftReport.companyData.line7}}<br /></span>
              </div>
            </div>
          </div>
          <div class="row">
            <div class="col-12 text-right">
              <span class="link pointer" (click)="changeCompany()" (keydown.enter)="changeCompany()" aria-label="Modifier entreprise" tabindex="0">Modifier</span>&nbsp;<i class="material-icons md-18 edit" aria-hidden="true">edit</i>
            </div>
          </div>
          <hr />
          <button type="submit" class="btn btn-lg btn-primary">
            <i class="material-icons md-24 d-none d-sm-inline-block" aria-hidden="true">play_arrow</i>
            Étape suivante : s'identifier
          </button>
        </form>

        <ng-template #noCompany>

          <nav class="nav nav-tabs nav-justified" role="tablist">
            <a id="firstTab" class="nav-item nav-link pointer" (click)="changeNavTab()" (keydown.enter)="changeNavTab()" [ngClass]="{'active': !bySiret}" role="tab">Recherche par nom</a>
            <a class="nav-item nav-link pointer" (click)="changeNavTab()" (keydown.enter)="changeNavTab()" [ngClass]="{'active': bySiret}" role="tab">Recherche par SIRET</a>
          </nav>

          <ng-container *ngIf="!bySiret; else searchBySiret" role="tabpanel">

            <form [formGroup]="searchForm" (submit)="searchCompany()" id="searchForm" *ngIf="searchForm">

              <div class="form__group mt-4">
                <label for="searchInput" [class]="hasError(searchCtrl) ? 'error' : ''">Nom ou enseigne de l'entreprise signalée <span class="error">*</span>
                </label>
                <input type="text" class="form-control" formControlName="search" name="search" id="searchInput" placeholder="ex : boulangerie Petit Jean"/>
              </div>
              <div class="form__group">
                <label for="searchPostalCodeInput"[class]="hasError(searchPostalCodeCtrl) ? 'error' : ''">
                  Code postal <span class="error">*</span>
                </label>
                <div class="row">
                  <div class="col-12 col-sm-6">
                    <input type="text" class="form-control" formControlName="searchPostalCode" name="searchPostalCode" id="searchPostalCodeInput" placeholder="ex : 41110" />
                  </div>
                </div>
              </div>
              <div>
                <small class="form-text text-muted">
                  Vous pouvez signaler des entreprises privées établies en France uniquement.
                </small>
              </div>
              <div class="notification error mt-4" *ngIf="showErrors && searchForm.invalid">
                <span *ngIf="searchCtrl.hasError('required')">
                  Veuillez renseigner le nom de l'entreprise.<br />
                </span>
                <span *ngIf="searchPostalCodeCtrl.hasError('required')">
                  Veuillez renseigner le code postal.
                </span>
                <span *ngIf="searchPostalCodeCtrl.hasError('pattern')">
                  Le code postal doit être composé de 5 chiffres.
                </span>
              </div>
              <hr />
              <div class="my-5">
                <button type="submit" class="btn btn-lg btn-primary" id="submitSearchForm">
                  <i class="material-icons md-24" aria-hidden="true">search</i>
                  Rechercher
                </button>
              </div>

            </form>

            <div *ngIf="companySearchResults && companySearchResults.length">

              <p class="mt-4">
                Veuillez sélectionner une entreprise dans la liste ci-dessous :
              </p>

              <p *ngFor="let companySearchResult of companySearchResults" class="company" (click)="selectCompanyFromResults(companySearchResult)" (keydown.enter)="selectCompanyFromResults(companySearchResult)" tabindex="0">
                <strong *ngIf="companySearchResult.line1">{{companySearchResult.line1}}<br /></strong>
                <strong *ngIf="companySearchResult.line2">{{companySearchResult.line2}}<br /></strong>
                <strong *ngIf="companySearchResult.highlight">
                  <i class="material-icons md-green">check_circle</i>
                  <small class="text-success font-weight-bold">{{companySearchResult.highlight}}</small>
                  <br />
                </strong>
                <span *ngIf="companySearchResult.activityLabel">{{companySearchResult.activityLabel}}<br /></span>
                <span *ngIf="companySearchResult.line3">{{companySearchResult.line3}}<br /></span>
                <span *ngIf="companySearchResult.line4">{{companySearchResult.line4}}<br /></span>
                <span *ngIf="companySearchResult.line5">{{companySearchResult.line5}}<br /></span>
                <span *ngIf="companySearchResult.line6">{{companySearchResult.line6}}<br /></span>
                <span *ngIf="companySearchResult.line7">{{companySearchResult.line7}}<br /></span>
              </p>

              <div class="notification info mt-4">
                Si l'entreprise ne figure pas dans la liste, vous pouvez modifier votre recherche ou <span class="link" (click)="changeNavTab()" (keydown.enter)="changeNavTab()" tabindex="0">rechercher avec le numéro SIRET de l'entreprise</span>.
              </div>
            </div>

            <div class="notification warning mt-4" *ngIf="searchWarning">
              <p>
                {{searchWarning}}
              </p>
              Veuillez modifier votre recherche ou <span class="link" (click)="changeNavTab()">rechercher avec le numéro SIRET de l'entreprise</span>.
            </div>

            <div class="notification error mt-4" *ngIf="searchError">
              <p>
                {{searchError}}
              </p>
              Veuillez réessayer ou <span class="link" (click)="changeNavTab()">rechercher avec le numéro SIRET de l'entreprise</span>.
            </div>
          </ng-container>

          <ng-template #searchBySiret role="tabpanel">

            <form [formGroup]="searchBySiretForm" (submit)="searchCompanyBySiret()" id="searchBySiretForm" *ngIf="searchBySiretForm">

              <div class="notification">
                <p>
                  Le SIRET est un numéro composé de 14 chiffres identifiant l'entreprise concernée.
                  Signalconso en a besoin pour la contacter et informer la répression des fraudes.
                </p>
                <p>
                  <a data-toggle="collapse" href="#collapseHow">Comment retrouver un SIRET ?</a>
                </p>
                <ul class="collapse" id="collapseHow">
                  <li>
                    <a data-toggle="collapse" href="#collapseDoc">L'entreprise vous a remis un document ?</a>
                    <div class="collapse" id="collapseDoc">
                      Vous pourrez probablement retrouver le SIRET sur :
                      <ul>
                        <li>
                          <a data-toggle="collapse" href="#collapseTicket">le ticket de carte bleue</a>
                          <div class="collapse" id="collapseTicket">
                            <div class="card card-body">
                              Il y a plusieurs données chiffrées sur ce ticket mais vous pouvez facilement trouver le numéro à 14 chiffres qui se situe en principe entre l’adresse de l'entreprise et le montant de votre achat.
                            </div>
                          </div>
                        </li>
                        <li>
                          <a data-toggle="collapse" href="#collapseEstimate">un devis</a>
                          <div class="collapse" id="collapseEstimate">
                            <div class="card card-body">
                              Vous trouverez le plus souvent le numéro à 14 chiffres en dessous de l’adresse de l'entreprise (généralement en haut à gauche).
                            </div>
                          </div>
                        </li>
                        <li>
                          <a data-toggle="collapse" href="#collapseContract">un contrat</a>
                          <div class="collapse" id="collapseContract">
                            <div class="card card-body">
                              Vous trouverez le plus souvent le numéro à 14 chiffres en dessous de l’adresse de l'entreprise (généralement en haut à gauche).
                            </div>
                          </div>
                        </li>
                        <li>
                          Tout autre document ou échange avec l'entreprise (document publicitaire, signature à la fin d’un mail, grille des tarifs…).
                        </li>
                      </ul>
                    </div>
                  </li>
                  <li>
                    <a data-toggle="collapse" href="#collapseNoDoc">Vous n’avez pas de documents émanants de l'entreprise ?</a>
                    <div class="collapse" id="collapseNoDoc">
                      Faites une recherche en ligne sur :
                      <ul>
                        <li><a href="https://www.societe.com" target="_blank" title="societe.com (nouvelle fenêtre)">https://www.societe.com</a></li>
                        <li><a href="https://www.pagesjaunes.fr" target="_blank" title="pages jaunes (nouvelle fenêtre)">https://www.pagesjaunes.fr</a></li>
                        <li><a href="https://www.infogreffe.fr" target="https://www.infogreffe.fr" title="infogreffe (nouvelle fenêtre)">https://www.infogreffe.fr</a></li>
                      </ul>
                    </div>
                  </li>
                  <li>
                    <a data-toggle="collapse" href="#collapseNotFound">Vous n’avez pas trouvé le numéro SIRET ?</a>
                    <div class="collapse" id="collapseNotFound">
                      Utiliser <a href="https://www.economie.gouv.fr/contact/contacter-la-dgccrf?dest=professionnel" target="_blank">le formulaire en ligne DGCCRF</a>
                      <br />Ce formulaire ne nécessite pas le SIRET de l'entreprise.
                    </div>
                  </li>
                </ul>
              </div>

              <div class="form__group mt-4">
                <label for="siret" [class]="hasErrorBySiret(siretCtrl) ? 'error' : ''">
                  Numéro SIRET de l'entreprise <span class="error">*</span>
                </label>
                <input formControlName="siret" type="text" id="siret" placeholder="Ex: 83350861700010">
              </div>

              <div class="notification error mt-3" *ngIf="showErrorsBySiret && searchBySiretForm.invalid">
                <span *ngIf="siretCtrl.hasError('required')">
                  Veuillez renseigner le numéro SIRET de l'entreprise.<br />
                </span>
                <span *ngIf="siretCtrl.hasError('pattern')">
                  Le numéro SIRET doit être composé de 14 chiffres.
                </span>
              </div>
              <hr />
              <div class="my-5">
                <button type="submit" class="btn btn-lg btn-primary" id="submitSiretForm">
                  <i class="material-icons md-24" aria-hidden="true">search</i>
                  Rechercher
                </button>
              </div>

            </form>

            <div *ngIf="companySearchBySiretResult">

              <p class="mt-4">
                Veuillez cliquer sur l'entreprise ci-dessous si elle correspond bien à l'entreprise recherché :
              </p>

              <p class="company" (click)="selectCompanyFromResults(companySearchBySiretResult)" (keydown.enter)="selectCompanyFromResults(companySearchBySiretResult)" tabindex="0">
                <strong *ngIf="companySearchBySiretResult.line1">{{companySearchBySiretResult.line1}}<br /></strong>
                <strong *ngIf="companySearchBySiretResult.line2">{{companySearchBySiretResult.line2}}<br /></strong>
                <span *ngIf="companySearchBySiretResult.activityLabel">{{companySearchBySiretResult.activityLabel}}<br /></span>
                <span *ngIf="companySearchBySiretResult.line3">{{companySearchBySiretResult.line3}}<br /></span>
                <span *ngIf="companySearchBySiretResult.line4">{{companySearchBySiretResult.line4}}<br /></span>
                <span *ngIf="companySearchBySiretResult.line5">{{companySearchBySiretResult.line5}}<br /></span>
                <span *ngIf="companySearchBySiretResult.line6">{{companySearchBySiretResult.line6}}<br /></span>
                <span *ngIf="companySearchBySiretResult.line7">{{companySearchBySiretResult.line7}}<br /></span>
              </p>

              <div class="notification info mt-4">
                Si l'entreprise n'est pas celle recherchée, vous pouvez modifier votre recherche.
              </div>
            </div>

            <div class="notification warning mt-4" *ngIf="searchBySiretWarning">
              <p>
                {{searchBySiretWarning}}
              </p>
              Veuillez modifier votre recherche.
            </div>

            <div class="notification error mt-4" *ngIf="searchBySiretError">
              <p>
                {{searchBySiretError}}
              </p>
              Veuillez réessayer.
            </div>
          </ng-template>
        </ng-template>
      </ng-container>

      <ng-template #website>
        <form [formGroup]="websiteForm" (submit)="submitWebsiteForm()" id="websiteForm" *ngIf="websiteForm">

          <div class="form__group mt-4">
            <label for="urlInput" [class]="hasError(urlCtrl) ? 'error' : ''">Adresse du site internet (URL) <span class="error">*</span>
            </label>
            <input type="text" class="form-control" [formControl]="urlCtrl" name="url" id="urlInput" placeholder="ex : https://www.site.fr"/>
          </div>
          <div class="notification error mt-4" *ngIf="showErrors && websiteForm.invalid">
            <span *ngIf="urlCtrl.hasError('required')">
              Veuillez renseigner l'url du site.<br />
            </span>
          </div>
          <hr />
          <div class="my-5">
            <button type="submit" class="btn btn-lg btn-primary">
              Valider
            </button>
          </div>

        </form>
      </ng-template>
    </ng-container>

  </div>

  <ngx-loading [show]="loading"></ngx-loading>

</section>
