<app-banner title="Suivi des signalements"
            [subTitle]="reportFilter.siret ? 'SIRET ' + reportFilter.siret : ''"
            [backButton]="reportFilter.siret">
</app-banner>

<app-page>
  <form (ngSubmit)="submitFilters()" *ngIf="withPagingAndFiltering()">
    <div class="row form-group">
      <div class="col-12 col-sm-6">
        <label for="input-start">
          Période
        </label>

      </div>
      <div class="col-8 col-sm-4">
        <label for="statusFilter">
          Statut <a [routerLink]="['/comment-ça-marche/professionnel']" fragment="les-status">
          <i class="material-icons md-24" aria-hidden="true">help_outline</i>
          <span class="sr-only">Consulter l'aide</span>
        </a>
        </label>
        <select class="form-control" [(ngModel)]="reportFilter.status" placeholder="Statut" id="statusFilter"
                name="status" [class]="reportFilter.status ? 'selected' : ''">
          <option [ngValue]="undefined" selected>Tous les statuts</option>
          <option *ngFor="let status of statusList$ | async">
            {{status}}
          </option>
        </select>
      </div>
      <div class="col-4 col-sm-2">
        <button type="submit" class="btn btn-outline-secondary btn-sm b-0">Filtrer</button>
      </div>
    </div>
  </form>

  <div class="notification success mb-5" *ngIf="isFirstVisit()">
    <i class="material-icons md-18 attach-icon">check_circle</i> Votre compte est bien activé, vous pouvez consulter
    <strong>votre signalement</strong>.
  </div>

  <app-panel>
    <app-panel-header>
      <ng-container *ngIf="withFiltering">
        <mat-date-range-input [rangePicker]="picker" (click)="picker.open()" class="form-control form-control-material">
          <input [(ngModel)]="reportFilter.start" name="start" matStartDate placeholder="Période sélectionnée"
                 id="input-start">
          <input [(ngModel)]="reportFilter.end" name="end" matEndDate placeholder="">
        </mat-date-range-input>
        <mat-date-range-picker #picker></mat-date-range-picker>

        <mat-select [(ngModel)]="reportFilter.status" id="rls-statut" class="form-control form-control-material">
          <!--        <mat-select-trigger>{{reportFilter.status}}</mat-select-trigger>-->
          <mat-option [value]="undefined" selected>Tous les statuts</mat-option>
          <mat-option *ngFor="let _ of statusList$ | async" [value]="_" class="mat-option-dense">
            <app-badge-status [status]="_">{{_}}</app-badge-status>
          </mat-option>
        </mat-select>
      </ng-container>

      <div class="txt-secondary text-nowrap">
        <button mat-icon-button matTooltip="Supprimer tous les filtres" *ngIf="withFiltering" (click)="cancelFilters()">
          <mat-icon>clear</mat-icon>
        </button>
        <button mat-raised-button color="primary" type="button" (click)="launchExtraction()">
          Exporter (XLS)
        </button>
      </div>

    </app-panel-header>

    <div class="table-overflow">
      <table mat-table [dataSource]="reports" class="fullwidth">
        <ng-container matColumnDef="creationDate">
          <th mat-header-cell *matHeaderCellDef>Date de réception</th>
          <td mat-cell *matCellDef="let _">
            {{_.creationDate | date : 'dd/MM/yyyy' }}
          </td>
        </ng-container>

        <ng-container matColumnDef="consumerUploadedFiles">
          <th mat-header-cell *matHeaderCellDef>PJ</th>
          <td mat-cell *matCellDef="let _">
            <mat-icon aria-hidden="true" title="Pièces jointes" *ngIf="_.consumerUploadedFiles.length">
              attach_file
            </mat-icon>
          </td>
        </ng-container>

        <ng-container matColumnDef="status">
          <th mat-header-cell *matHeaderCellDef>Statut</th>
          <td mat-cell *matCellDef="let _">
            <app-badge-status [status]="_.status"></app-badge-status>
          </td>
        </ng-container>

        <ng-container matColumnDef="consumer">
          <th mat-header-cell *matHeaderCellDef>Consommateur</th>
          <td mat-cell *matCellDef="let _">
            {{_.contactAgreement ? _.consumer.firstName + ' ' + _.consumer.lastName : 'Signalement anonyme'}}
            <mat-icon class="float-right txt-secondary" aria-hidden="true" title="Détail du signalement">
              keyboard_arrow_right
            </mat-icon>
          </td>
        </ng-container>

        <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
        <tr class="tr hoverable" mat-row *matRowDef="let _; columns: displayedColumns;"
            [ngClass]="_.status === reportStatus.UnreadForPro ? 'font-weight-bold' : ''"
            [routerLink]="['/suivi-des-signalements', 'report', _.id]"></tr>
      </table>
    </div>
    <mat-paginator *ngIf="withPagingAndFiltering()"
                   (page)="changePage($event)"
                   [pageIndex]="currentPage"
                   [length]="totalCount"
                   [pageSize]="itemsPerPage"
                   [pageSizeOptions]="[5, 10, 25, 100]"></mat-paginator>
  </app-panel>

  <div class="notification error" *ngIf="loadingError">
    Une erreur technique s'est produite
  </div>

  <div class="col-12 text-center">
    Aucun signalement trouvé
  </div>

  <div class="row pt-3" *ngIf="withPagingAndFiltering()">
    <div class="col-12 col-sm-6">
      <!--        <pagination [boundaryLinks]="true" [totalItems]="totalCount" [maxSize]="3" [itemsPerPage]="itemsPerPage"-->
      <!--                    (pageChanged)="changePage($event)"-->
      <!--                    [(ngModel)]="currentPage" previousText="&lsaquo;" nextText="&rsaquo;" firstText="&laquo;"-->
      <!--                    lastText="&raquo;" class="justify-content-center">-->
      <!--        </pagination>-->
    </div>
    <div class="col-12 col-sm-6 text-center text-sm-right">
      <button type="button" class="btn btn-outline-success btn-sm" (click)="launchExtraction()">
        Exporter (XLS)
      </button>
    </div>
  </div>
</app-page>
